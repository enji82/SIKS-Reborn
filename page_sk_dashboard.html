
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    /* Keyframes untuk Slide Up Halus */
    @keyframes slideUpFade {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* Terapkan animasi bertahap (staggered) */
    .animate-entry {
        opacity: 0; /* Mulai sembunyi */
        animation: slideUpFade 0.8s cubic-bezier(0.2, 0.8, 0.2, 1) forwards;
    }
    
    /* Delay untuk urutan muncul */
    .delay-1 { animation-delay: 0.1s; }
    .delay-2 { animation-delay: 0.2s; }
    .delay-3 { animation-delay: 0.3s; }
    .delay-4 { animation-delay: 0.4s; }
</style>

<div class="main-wrapper" style="height: 100%; display: flex; flex-direction: column; overflow-y: auto;">
  
  <div class="page-title-container animate-entry" style="margin-bottom: 20px;">
    <h2 class="page-title" style="border-left: 5px solid #00c3ff; padding-left: 15px;">Dashboard Monitoring</h2>
  </div>

  <div class="card-grid animate-entry delay-1" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
      <div class="glass-panel" style="padding: 20px; text-align: center; border-bottom: 4px solid #3498db;">
          <h1 id="txtTotal" class="counter-num" style="font-size: 2.5em; margin: 0; color: #fff;">0</h1>
          <span style="color: #aaa; font-size: 13px;">TOTAL UNGGAH</span>
      </div>
      <div class="glass-panel" style="padding: 20px; text-align: center; border-bottom: 4px solid #f1c40f;">
          <h1 id="txtProses" class="counter-num" style="font-size: 2.5em; margin: 0; color: #f1c40f;">0</h1>
          <span style="color: #aaa; font-size: 13px;">MENUNGGU VERIFIKASI</span>
      </div>
      <div class="glass-panel" style="padding: 20px; text-align: center; border-bottom: 4px solid #2ecc71;">
          <h1 id="txtTerima" class="counter-num" style="font-size: 2.5em; margin: 0; color: #2ecc71;">0</h1>
          <span style="color: #aaa; font-size: 13px;">DITERIMA / VALID</span>
      </div>
      <div class="glass-panel" style="padding: 20px; text-align: center; border-bottom: 4px solid #e74c3c;">
          <h1 id="txtTolak" class="counter-num" style="font-size: 2.5em; margin: 0; color: #e74c3c;">0</h1>
          <span style="color: #aaa; font-size: 13px;">DITOLAK / REVISI</span>
      </div>
  </div>

  <div class="animate-entry delay-2" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 25px;">
      
      <div class="glass-panel" style="padding: 15px;">
          <h4 style="margin: 0 0 15px 0; color: #fff; text-align: center;">Komposisi Status</h4>
          <div style="height: 250px; position: relative;">
              <canvas id="chartStatus"></canvas>
          </div>
      </div>

      <div class="glass-panel" style="padding: 15px;">
          <h4 style="margin: 0 0 15px 0; color: #fff; text-align: center;">Tren Upload Bulanan</h4>
          <div style="height: 250px; position: relative;">
              <canvas id="chartBulanan"></canvas>
          </div>
      </div>
  </div>

  <div class="glass-panel animate-entry delay-3" style="padding: 0; margin-bottom: 20px;">
      <div style="padding: 12px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); background: rgba(0,0,0,0.2);">
          <strong style="color: #fff;"><i class="fas fa-history"></i> 5 Aktivitas Terakhir</strong>
      </div>
      <table class="data-table" style="width: 100%;">
          <thead>
              <tr>
                  <th class="text-center">Tanggal</th>
                  <th class="text-left">Nama SD</th>
                  <th class="text-center">Tahun Ajaran</th>
                  <th class="text-center">Semester</th>
                  <th class="text-center">Kriteria SK</th>
              </tr>
          </thead>
          <tbody id="tblRecent">
              <tr><td colspan="5" class="text-center p-3">Memuat data...</td></tr>
          </tbody>
      </table>
  </div>
</div>

<script>
    var chartStatusInstance = null;
    var chartBulananInstance = null;

    window.initSkDashboardPage = function() {
        google.script.run.withSuccessHandler(renderDashboard).getSKDashboardData();
    };

    function renderDashboard(data) {
        if(data.error) { console.error(data.error); return; }

        // 1. Animasi Angka (Counter Up)
        animateValue("txtTotal", 0, data.total || 0, 1500);
        animateValue("txtTerima", 0, data.statusCounts['OK'] || 0, 1500);
        animateValue("txtTolak", 0, data.statusCounts['Ditolak'] || 0, 1500);
        animateValue("txtProses", 0, data.statusCounts['Diproses'] || 0, 1500);

        // 2. Render Charts
        renderPieChart(data.statusCounts);
        renderBarChart(data.monthlyCounts);

        // 3. Render Tabel
        var tbody = $('#tblRecent').empty();
        if (!data.recent || data.recent.length === 0) {
             tbody.append('<tr><td colspan="5" class="text-center p-3">Belum ada data unggahan.</td></tr>');
        } else {
            data.recent.forEach(r => {
                 tbody.append(`
                    <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                        <td class="text-center" style="padding:8px;">${r.Tanggal}</td>
                        <td class="text-left" style="padding:8px; font-weight:bold;">${r.NamaSD}</td>
                        <td class="text-center" style="padding:8px;">${r.Tahun}</td>
                        <td class="text-center" style="padding:8px;">${r.Semester}</td>
                        <td class="text-center" style="padding:8px;">${r.Kriteria}</td>
                    </tr>
                 `);
            });
        }
    }

    // Fungsi Animasi Counter Angka
    function animateValue(id, start, end, duration) {
        var obj = document.getElementById(id);
        if(!obj) return;
        var range = end - start;
        var current = start;
        var increment = end > start ? 1 : -1;
        var stepTime = Math.abs(Math.floor(duration / range));
        
        if (range === 0) { obj.innerHTML = end; return; }
        
        // Agar tidak terlalu lambat jika angkanya besar
        if(stepTime < 10) stepTime = 10;
        increment = Math.ceil(range / (duration / 10));

        var timer = setInterval(function() {
            current += increment;
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                current = end;
                clearInterval(timer);
            }
            obj.innerHTML = current;
        }, 10);
    }

    function renderPieChart(counts) {
        const ctx = document.getElementById('chartStatus').getContext('2d');
        if (chartStatusInstance) chartStatusInstance.destroy();

        chartStatusInstance = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['OK / Diterima', 'Revisi / Ditolak', 'Diproses'],
                datasets: [{
                    data: [counts['OK'], counts['Ditolak'], counts['Diproses']],
                    backgroundColor: ['#2ecc71', '#e74c3c', '#f1c40f'],
                    borderWidth: 0,
                    hoverOffset: 10 // Efek saat hover
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    animateScale: true,
                    animateRotate: true,
                    duration: 2000,
                    easing: 'easeOutQuart' // Easing halus
                },
                plugins: { 
                    legend: { position: 'bottom', labels: { color: '#fff', padding: 20 } } 
                }
            }
        });
    }

    function renderBarChart(monthly) {
        const ctx = document.getElementById('chartBulanan').getContext('2d');
        if (chartBulananInstance) chartBulananInstance.destroy();

        // --- PERBAIKAN: URUTKAN BULAN SECARA KALENDER ---
        
        // 1. Daftar Bulan Standar (Urut)
        var standardMonths = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        
        var sortedLabels = [];
        var sortedData = [];

        // 2. Loop urut dari Jan s/d Des
        standardMonths.forEach(function(bulan) {
            // Cek apakah bulan tersebut ada datanya di 'monthly'
            // Jika ada, masukkan ke array grafik. Jika tidak, lewati (atau isi 0 jika ingin grafik penuh)
            if (monthly[bulan] !== undefined) {
                sortedLabels.push(bulan);
                sortedData.push(monthly[bulan]);
            }
        });

        // ------------------------------------------------

        chartBulananInstance = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: sortedLabels, // Gunakan label yang sudah urut
                datasets: [{
                    label: 'Jumlah Upload',
                    data: sortedData,     // Gunakan data yang sudah urut
                    backgroundColor: 'rgba(0, 195, 255, 0.7)',
                    borderColor: '#00c3ff',
                    borderWidth: 1,
                    borderRadius: 5,
                    barPercentage: 0.6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: {
                    duration: 1500,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: { 
                        beginAtZero: true,
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { stepSize: 1, color: '#aaa' } // stepSize: 1 agar tidak ada angka desimal (0.5)
                    },
                    x: { 
                        grid: { display: false }, 
                        ticks: { color: '#aaa' } 
                    }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    window.initSkDashboardPage();
</script>