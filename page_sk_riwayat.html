<?!= include('css'); ?>

<div class="main-wrapper" style="animation: fadeIn 0.4s ease-in-out; height: 100%; display: flex; flex-direction: column;">
  
  <div class="page-title-container" style="margin-bottom: 20px;">
    <h2 class="page-title" style="border-left: 5px solid #00c3ff; padding-left: 15px;">Riwayat Pengiriman SK</h2>
  </div>

  <div class="filter-container items-bottom">
      
      <div class="filter-group filter-group-vertical">
        <label>Tahun Ajaran</label>
        <select id="filterTahun" class="custom-select" style="width: 120px;"></select>
      </div>

      <div class="filter-group filter-group-vertical">
        <label>Semester</label>
        <select id="filterSemester" class="custom-select" style="width: 120px;"></select>
      </div>

      <div class="filter-group filter-group-vertical">
        <label>Nama Sekolah</label>
        <select id="filterNamaSekolah" class="custom-select" style="min-width: 200px;"></select>
      </div>
      
      <button onclick="refreshData()" class="btn-refresh-glass" title="Reset & Refresh Data">
        <i class="fas fa-sync-alt"></i>
      </button>
  </div>

  <main class="table-view-container" style="flex:1; display:flex; flex-direction:column; min-height:0; overflow: hidden;">

    <div id="loadingStatus" style="display:none; flex-direction:column; justify-content:center; align-items:center; height: 100%;">
        <div class="spinner-container" style="display:flex; gap:6px;">
            <div class="spinner-bar" style="background:#00c3ff; width:4px; height:20px; animation: bounce 1s infinite;"></div>
            <div class="spinner-bar" style="background:#00c3ff; width:4px; height:20px; animation: bounce 1s infinite 0.2s;"></div>
            <div class="spinner-bar" style="background:#00c3ff; width:4px; height:20px; animation: bounce 1s infinite 0.4s;"></div>
        </div>
        <p style="color: #bbb; margin-top: 15px; font-size: 12px; letter-spacing: 1px;">MEMUAT DATA...</p>
    </div>

    <div id="tableWrapper" style="display:flex; flex-direction:column; height:100%;">
        <div class="table-container" style="flex:1; overflow:auto;">
            <table id="riwayatTable" class="data-table" style="width:100%; border-collapse:collapse;">
                <thead style="position: sticky; top: 0; z-index: 10;"></thead>
                <tbody style="color:#ddd; font-size: 14px;"></tbody>
            </table>
        </div>
        <div style="padding: 10px; color: #7f8c8d; font-size: 12px; text-align: right; border-top: 1px solid #2c3e50;">
            Total Data: <strong id="totalDataCount" style="color: #fff;">0</strong>
        </div>
    </div>
    
  </main>
</div>

<div id="previewModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:99999; backdrop-filter: blur(5px);">
    <div style="position:relative; width:95%; height:90%; margin:2.5% auto; background:#1e272e; border-radius:8px; overflow:hidden; border: 1px solid #34495e;">
        <div style="padding:10px 20px; background:#000; color:#fff; display:flex; justify-content:space-between; align-items:center; border-bottom: 1px solid #34495e;">
            <span style="font-weight:bold; font-size: 14px;"><i class="fas fa-file-pdf"></i> PREVIEW DOKUMEN</span>
            <button onclick="closePreview()" style="background:transparent; border:none; color:#e74c3c; cursor:pointer; font-size: 20px;"><i class="fas fa-times"></i></button>
        </div>
        <iframe id="previewIframe" src="" style="width:100%; height:calc(100% - 45px); border:none;"></iframe>
    </div>
</div>

<script>
  var allRiwayatData = []; 

  // INIT PAGE
  window.initSkRiwayatPage = function() {
      $('#loadingStatus').css('display', 'flex'); 
      $('#tableWrapper').hide();
      
      google.script.run
        .withSuccessHandler(renderRiwayatTable)
        .withFailureHandler(function(err) {
           $('#loadingStatus').hide();
           Swal.fire('Gagal', 'Gagal memuat data: ' + err.message, 'error');
        })
        .getSKRiwayatData(); 
  };

  // REFRESH DATA
  window.refreshData = function() {
      $('#filterTahun').val('Semua');
      $('#filterSemester').val('Semua');
      $('#filterNamaSekolah').val('Semua');
      window.initSkRiwayatPage();
  }

  // RENDER TABLE
  function renderRiwayatTable(data) {
    allRiwayatData = data.rows || [];
    var $thead = $('#riwayatTable thead').empty();
    
    // Header Tabel
    var h = `<tr>
        <th style="padding:15px; text-align:center; width: 40px;">No</th>
        <th style="padding:15px; text-align:left;">Nama Sekolah</th>
        <th style="padding:15px; text-align:center;">Tahun</th>
        <th style="padding:15px; text-align:center;">Semester</th>
        <th style="padding:15px; text-align:left;">Nomor SK</th>
        <th style="padding:15px; text-align:center;">Tgl SK</th>
        <th style="padding:15px; text-align:center;">Status</th>
        <th style="padding:15px; text-align:center;">Dokumen</th>
        <th style="padding:15px; text-align:left;">User Input</th>
    </tr>`;
    $thead.append(h);

    if($('#filterTahun').val() === null || $('#filterTahun').children().length === 0) {
        populateFilter('filterTahun', 'Tahun Ajaran');
        populateFilter('filterSemester', 'Semester');
        populateFilter('filterNamaSekolah', 'Nama SD');
    }
    
    applyRiwayatFilter();
    
    $('#loadingStatus').hide();
    $('#tableWrapper').fadeIn(300);
  }

  // FILTER LOGIC
  function applyRiwayatFilter() {
    var fTahun = $('#filterTahun').val() || 'Semua';
    var fSem = $('#filterSemester').val() || 'Semua';
    var fSekolah = $('#filterNamaSekolah').val() || 'Semua';

    var filtered = allRiwayatData.filter(function(r) {
      return (fTahun === 'Semua' || r['Tahun Ajaran'] === fTahun) && 
             (fSem === 'Semua' || r['Semester'] === fSem) &&
             (fSekolah === 'Semua' || r['Nama SD'] === fSekolah);
    });
    
    var $tbody = $('#riwayatTable tbody').empty();
    
    if (filtered.length === 0) {
        $tbody.append('<tr><td colspan="9" style="text-align:center; padding:30px; color:#7f8c8d;">Data tidak ditemukan.</td></tr>');
    } else {
        filtered.forEach(function(r, i) {
          // Status Logic (Menggunakan Class CSS Global baru)
          var rawStatus = r['Status'] || 'Diproses';
          var sClass = 'status-diproses'; 
          
          if(rawStatus.match(/tolak/i)) sClass = 'status-ditolak';
          else if(rawStatus.match(/revisi/i)) sClass = 'status-revisi';
          else if(rawStatus.match(/ok|terima/i)) sClass = 'status-ok';

          // Tombol Lihat (Menggunakan Class CSS Global baru)
          var btn = r['Dokumen'] && r['Dokumen'] !== '#' ? 
            `<button onclick="openPreview('${r['Dokumen']}')" class="btn-lihat-premium">
                <i class="fas fa-eye"></i> Lihat
             </button>` : 
            '<span style="color:#555;">-</span>';

          var userInput = r['User Input'] || '-';

          var tr = `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
              <td style="text-align:center; padding:12px;">${i+1}</td>
              <td style="padding:12px;">${r['Nama SD']||'-'}</td>
              <td style="text-align:center; padding:12px;">${r['Tahun Ajaran']||'-'}</td>
              <td style="text-align:center; padding:12px;">${r['Semester']||'-'}</td>
              <td style="padding:12px;">${r['Nomor SK']||'-'}</td>
              <td style="text-align:center; padding:12px;">${r['Tanggal SK']||'-'}</td>
              <td style="text-align:center; padding:12px;"><span class="status-badge ${sClass}">${rawStatus}</span></td>
              <td style="text-align:center; padding:12px;">${btn}</td>
              <td style="text-align:left; padding:12px;">${userInput}</td> 
          </tr>`;
          $tbody.append(tr);
        });
    }
    $('#totalDataCount').text(filtered.length);
  }

  function populateFilter(id, key) {
    var unique = [...new Set(allRiwayatData.map(r => r[key]))].filter(v => v).sort();
    var $sel = $('#' + id);
    var currentVal = $sel.val(); 

    $sel.empty().append('<option value="Semua">Semua</option>');
    unique.forEach(function(v){ 
        $sel.append(`<option value="${v}">${v}</option>`) 
    });
    
    if(currentVal && unique.includes(currentVal)) {
        $sel.val(currentVal);
    } else {
        $sel.val('Semua');
    }
  }

  // EVENT LISTENER
  $('#filterTahun, #filterSemester, #filterNamaSekolah').off('change').on('change', applyRiwayatFilter);

  // PREVIEW DOKUMEN
  window.openPreview = function(url) {
    if (!url) return;
    var id = url.match(/[-\w]{25,}/); 
    if(id) {
        var previewUrl = "https://drive.google.com/file/d/" + id[0] + "/preview";
        $('#previewIframe').attr('src', previewUrl);
        $('#previewModal').fadeIn(200);
    } else {
        Swal.fire('Error', 'Link dokumen tidak valid', 'error');
    }
  }

  window.closePreview = function() {
    $('#previewModal').fadeOut(200);
    $('#previewIframe').attr('src', '');
  }

  // START
  window.initSkRiwayatPage();
</script>