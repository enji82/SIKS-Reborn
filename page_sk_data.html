<?!= include('css'); ?>

<style>
  /* Kustomisasi Tabel Lebar */
  .table-container { overflow-x: auto; }
  .data-table th, .data-table td { white-space: nowrap; padding: 8px 12px; }
  
  /* Modal Split */
  .modal-split-container { display: flex; height: 500px; gap: 15px; }
  .modal-split-left { flex: 1; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; overflow: hidden; }
  .modal-split-right { flex: 1; display: flex; flex-direction: column; overflow-y: auto; padding-right: 5px; }

  /* Input Locked */
  .input-locked { background: rgba(255,255,255,0.05) !important; border: 1px dashed rgba(255,255,255,0.1) !important; color: #aaa !important; cursor: not-allowed; }
</style>

<div class="main-wrapper" style="height: 100%; display: flex; flex-direction: column;">
  
  <div class="page-title-container" style="margin-bottom: 20px;">
    <h2 class="page-title" style="border-left: 5px solid #00c3ff; padding-left: 15px;">Data SK Pembagian Tugas</h2>
  </div>

  <div class="filter-container items-bottom">
      <div class="search-box-modern" style="flex: 0 0 200px; margin-right: auto;">
          <i class="fas fa-search"></i>
          <input type="text" id="searchInput" placeholder="Cari Sekolah / No SK...">
      </div>
      
      <select id="filterTahun" class="custom-select" style="min-width: 130px;">
          <option value="Semua">Semua Tahun</option>
      </select>

      <select id="filterSemester" class="custom-select" style="min-width: 130px;">
          <option value="Semua">Semua Sem.</option>
      </select>

      <select id="filterStatus" class="custom-select" style="min-width: 130px;">
          <option value="Semua">Semua Status</option>
          <option value="OK">OK</option>
          <option value="Diproses">Diproses</option>
          <option value="Revisi">Revisi</option>
          <option value="Ditolak">Ditolak</option>
      </select>
      
      <button onclick="refreshData()" class="btn-refresh-glass"><i class="fas fa-sync-alt"></i></button>
  </div>

  <main class="table-view-container" style="flex:1; display:flex; flex-direction:column; min-height:0; overflow: hidden;">
    <div id="loadingStatus" style="display:none; height: 100%; align-items:center; justify-content:center;">
        <div class="spinner-container"><div class="spinner-bar"></div><div class="spinner-bar"></div><div class="spinner-bar"></div></div>
    </div>

    <div id="tableWrapper" style="display:flex; flex-direction:column; height:100%;">
        <div class="table-container" style="flex:1; overflow:auto;">
            <table id="mainTable" class="data-table" style="width:100%; border-collapse:collapse;">
                <thead style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th class="text-center">No</th>
                        <th>Nama SD</th>
                        <th class="text-center">Tahun Ajaran</th>
                        <th class="text-center">Semester</th>
                        <th>Nomor SK</th>
                        <th class="text-center">Tanggal SK</th>
                        <th>Kriteria SK</th>
                        <th class="text-center">Dokumen</th>
                        <th class="text-center">Status</th>
                        <th class="text-center" style="min-width: 140px;">Aksi</th>
                        
                        <th style="color:#aaa;">Tgl Unggah</th>
                        <th style="color:#aaa;">User Input</th>
                        <th style="color:#aaa;">Update</th>
                        <th style="color:#aaa;">User Update</th>
                        <th style="color:#aaa;">Verval</th>
                        <th style="color:#aaa;">Verifikator</th>
                        <th style="color:#aaa;">Keterangan</th>
                    </tr>
                </thead>
                <tbody style="color:#ddd; font-size: 13px;"></tbody>
            </table>
        </div>
        <div style="padding: 10px; border-top: 1px solid #2c3e50; text-align: right; color: #7f8c8d;">
            Total Data: <strong id="totalDataCount" style="color: #fff;">0</strong>
        </div>
    </div>
  </main>
</div>

<div id="modalEdit" class="modal-overlay">
    <div class="modal-content" style="max-width: 600px; text-align: left;">
        <h3 style="border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-top: 0;">Edit Data SK</h3>
        <form id="formEdit" onsubmit="submitEdit(event)">
            <input type="hidden" id="editRowIndex">
            <input type="hidden" id="editOldDocUrl"> 
            
            <div class="form-grid-12" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div class="form-group">
                    <label>Nama SD (Terkunci)</label>
                    <input type="text" id="editNamaSD" class="input-locked" readonly>
                </div>
                <div class="form-group">
                    <label>Tahun Ajaran (Terkunci)</label>
                    <input type="text" id="editTahun" class="input-locked" readonly>
                </div>
            </div>
            
            <div class="form-grid-12" style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 10px;">
                <div class="form-group">
                    <label>Semester (Terkunci)</label>
                    <input type="text" id="editSem" class="input-locked" readonly>
                </div>
                <div class="form-group">
                    <label>Kriteria SK (Terkunci)</label>
                    <input type="text" id="editKriteria" class="input-locked" readonly>
                </div>
            </div>

            <div class="form-grid-12" style="display: grid; grid-template-columns: 2fr 1fr; gap: 15px; margin-top: 10px;">
                <div class="form-group">
                    <label>Nomor SK <span style="color:red">*</span></label>
                    <input type="text" id="editNomorSK" required>
                </div>
                <div class="form-group">
                    <label>Tanggal SK <span style="color:red">*</span></label>
                    <input type="date" id="editTanggalSK" required>
                </div>
            </div>

            <div class="glass-panel" style="padding: 15px; margin-top: 15px; background: rgba(255,255,255,0.05); border-radius: 6px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label style="margin:0; font-weight:600; color:#ddd;">File SK (Opsional)</label>
                    <button type="button" onclick="previewOldFile()" class="btn-lihat-premium" style="height: 24px !important; font-size: 11px !important; background: rgba(52, 152, 219, 0.2) !important;">
                        <i class="fas fa-external-link-alt"></i> Lihat File Saat Ini
                    </button>
                </div>
                
                <input type="file" id="editFileUpload" accept="application/pdf" style="font-size: 12px;">
                <div style="margin-top: 5px; font-size: 11px; color: #aaa;">
                    *Unggah hanya jika ingin mengganti file. Maks 1 MB (PDF).
                </div>
            </div>

            <div class="modal-actions" style="justify-content: flex-end; margin-top: 20px;">
                <button type="button" class="cancel-btn" onclick="$('#modalEdit').removeClass('show')">Batal</button>
                <button type="submit" id="btnSimpanEdit" class="delete-btn-confirm" style="background: linear-gradient(135deg, #f1c40f, #f39c12) !important;">
                    <i class="fas fa-save"></i> Simpan Perubahan
                </button>
            </div>
        </form>
    </div>
</div>

<div id="modalHapus" class="modal-overlay">
    <div class="modal-content" style="max-width: 400px;">
        <div style="text-align: center;">
            <i class="fas fa-trash-alt" style="font-size: 3em; color: #e74c3c; margin-bottom: 15px;"></i>
            <h3>Konfirmasi Hapus</h3>
            <p style="color: #ccc; font-size: 13px;">Pindahkan data ke Trash?</p>
        </div>
        <form id="formHapus" onsubmit="submitHapus(event)">
            <input type="hidden" id="hapusRowIndex">
            <div class="form-group" style="margin-top: 15px; text-align: left;">
                <label>Alasan <span style="color:red">*</span></label>
                <textarea id="hapusAlasan" rows="2" required placeholder="Contoh: Salah upload..." style="width:100%; padding:10px; background:rgba(0,0,0,0.2); border:1px solid #555; color:#fff; border-radius:4px;"></textarea>
            </div>
            <div class="form-group" style="margin-top: 10px; text-align: left;">
                <label>Ketik: <b>HAPUS</b></label>
                <input type="text" id="hapusKode" required style="width:100%; text-align:center; padding:8px; background:rgba(0,0,0,0.2); border:1px solid #555; color:#fff; border-radius:4px;">
            </div>
            <div class="modal-actions">
                <button type="button" class="cancel-btn" onclick="$('#modalHapus').removeClass('show')">Batal</button>
                <button type="submit" class="delete-btn-confirm">Hapus</button>
            </div>
        </form>
    </div>
</div>

<div id="modalVerif" class="modal-overlay">
    <div class="modal-content" style="max-width: 900px; width: 95%;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">
            <h3 style="margin:0;"><i class="fas fa-check-double" style="color:#2ecc71;"></i> Verifikasi Dokumen</h3>
            <button onclick="$('#modalVerif').removeClass('show')" style="background:none; border:none; color:#e74c3c; font-size:20px; cursor:pointer;"><i class="fas fa-times"></i></button>
        </div>
        <div class="modal-split-container">
            <div class="modal-split-left"><iframe id="verifPreviewFrame" src="" style="width:100%; height:100%; border:none;"></iframe></div>
            <div class="modal-split-right">
                <form id="formVerif" onsubmit="submitVerif(event)">
                    <input type="hidden" id="verifRowIndex">
                    <div style="background: rgba(255,255,255,0.05); padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                        <h4 style="margin:0 0 10px 0; color:#00c3ff; font-size:12px;">DATA INPUTAN</h4>
                        <div class="form-group"><label>Nama SD</label><input type="text" id="verifNamaSD" class="input-locked" readonly></div>
                        <div class="form-group" style="margin-top:5px;"><label>Nomor SK</label><input type="text" id="verifNomorSK" class="input-locked" readonly></div>
                        <div class="form-group" style="margin-top:5px;"><label>Kriteria</label><input type="text" id="verifKriteria" class="input-locked" readonly></div>
                    </div>
                    <div class="form-group">
                        <label>Keputusan <span style="color:red">*</span></label>
                        <select id="verifStatus" required style="background: #1a252f; color: white; padding: 10px; width: 100%; border-radius: 4px;">
                            <option value="Diproses">Diproses</option>
                            <option value="OK">OK (Diterima)</option>
                            <option value="Ditolak">Ditolak</option>
                        </select>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label>Keterangan</label>
                        <textarea id="verifKeterangan" rows="3" style="width:100%; padding:10px; background:rgba(0,0,0,0.2); border:1px solid #555; color:#fff; border-radius:4px;"></textarea>
                    </div>
                    <div style="margin-top: auto; padding-top: 15px;">
                        <button type="submit" class="submit-btn" style="background: #2ecc71; border:none; width:100%;">Simpan</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
var allData = [];
var currentUser = "Admin"; // Default

// --- INIT PAGE (REVISI: LOGIKA NAMA USER) ---
window.initSkDataPage = function() {
    $('#loadingStatus').css('display', 'flex');
    $('#tableWrapper').hide();
    
    // LOGIKA PINTAR PENGAMBILAN NAMA USER
    // Urutan prioritas: nama_lengkap > nama > username > "Admin"
    currentUser = "Admin"; // Default

    try {
        var userObj = null;

        // 1. Cek variable App (jika SPA berjalan)
        if (typeof App !== 'undefined' && App.currentUser) {
            userObj = App.currentUser;
        } 
        // 2. Jika tidak ada, cek LocalStorage
        else {
            var s = localStorage.getItem('siks_user_session');
            if (s) userObj = JSON.parse(s);
        }

        // 3. Ambil Nama Terbaik yang tersedia
        if (userObj) {
            if (userObj.nama_lengkap && userObj.nama_lengkap !== "") {
                currentUser = userObj.nama_lengkap;
            } else if (userObj.nama && userObj.nama !== "") {
                currentUser = userObj.nama;
            } else if (userObj.username) {
                currentUser = userObj.username;
            }
        }
    } catch(e) {
        console.warn("Gagal membaca session user:", e);
    }

    // (Opsional) Tampilkan di console untuk pengecekan
    console.log("User yang aktif untuk Edit/Hapus/Verif: " + currentUser);

    google.script.run
        .withSuccessHandler(renderTable)
        .withFailureHandler(err => Swal.fire('Error', err.message, 'error'))
        .getSKData();
}

window.refreshData = function() {
    $('#searchInput').val('');
    $('#filterTahun').val('Semua');
    $('#filterSemester').val('Semua');
    $('#filterStatus').val('Semua');
    window.initSkDataPage();
}

function renderTable(data) {
    allData = data.rows || [];
    var isAdmin = data.isAdmin;
    
    // 1. Populate Filter Tahun & Semester
    if($('#filterTahun').children().length <= 1) {
        var years = [...new Set(allData.map(r => r.tahun))].filter(v => v !== '-').sort();
        years.forEach(y => $('#filterTahun').append(`<option value="${y}">${y}</option>`));
        
        var sems = [...new Set(allData.map(r => r.sem))].filter(v => v !== '-').sort();
        sems.forEach(s => $('#filterSemester').append(`<option value="${s}">${s}</option>`));
    }
    
    applyFilter(isAdmin);
    $('#loadingStatus').hide();
    $('#tableWrapper').fadeIn();
}

function applyFilter(isAdmin) {
    var search = $('#searchInput').val().toLowerCase();
    var fTahun = $('#filterTahun').val();
    var fSem = $('#filterSemester').val();
    var fStatus = $('#filterStatus').val();

    var filtered = allData.filter(r => {
        var matchTahun = (fTahun === 'Semua' || r.tahun === fTahun);
        var matchSem = (fSem === 'Semua' || r.sem === fSem);
        var matchStatus = (fStatus === 'Semua' || (r.status||'').includes(fStatus));
        var matchSearch = !search || 
                          (r.noSK && r.noSK.toLowerCase().includes(search)) || 
                          (r.namaSD && r.namaSD.toLowerCase().includes(search));
        return matchTahun && matchSem && matchStatus && matchSearch;
    });

    var $tbody = $('#mainTable tbody').empty();
    
    filtered.forEach((r, i) => {
        // Badge
        var badge = 'status-diproses';
        if((r.status||'').match(/tolak/i)) badge = 'status-ditolak';
        else if((r.status||'').match(/ok|terima/i)) badge = 'status-ok';
        var statusBadge = `<span class="status-badge ${badge}">${r.status}</span>`;
        
        var isLocked = r.status === 'OK';
        
        // Tombol
        var btnDoc = r.dok && r.dok !== '#' ? `<button onclick="openDoc('${r.dok}')" class="btn-lihat-premium"><i class="fas fa-eye"></i></button>` : '-';
        var btnEdit = `<button onclick="openModalEdit(${i})" class="action-btn edit-btn" ${isLocked ? 'disabled style="filter:grayscale(1); opacity:0.5;"' : ''} title="Edit"><i class="fas fa-edit"></i></button>`;
        var btnHapus = `<button onclick="openModalHapus(${i})" class="action-btn delete-btn" ${isLocked ? 'disabled style="filter:grayscale(1); opacity:0.5;"' : ''} title="Hapus"><i class="fas fa-trash-alt"></i></button>`;
        var btnVerif = isAdmin ? `<button onclick="openModalVerif(${i})" class="action-btn" style="background:rgba(46, 204, 113, 0.2); color:#2ecc71; border:1px solid #2ecc71;" title="Verifikasi"><i class="fas fa-check-double"></i></button>` : '';

        var tr = `
        <tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">
            <td class="text-center">${i+1}</td>
            <td style="font-weight:600;">${r.namaSD}</td>
            <td class="text-center">${r.tahun}</td>
            <td class="text-center">${r.sem}</td>
            <td>${r.noSK}</td>
            <td class="text-center">${r.tglSK ? r.tglSK.split('T')[0] : '-'}</td>
            <td class="text-center">${r.kriteria}</td>
            <td class="text-center">${btnDoc}</td>
            <td class="text-center">${statusBadge}</td>
            <td class="text-center"><div style="display:flex; justify-content:center; gap:5px;">${btnEdit} ${btnHapus} ${btnVerif}</div></td>
            
            <td style="color:#aaa;">${r.tglUpload}</td>
            <td style="color:#aaa;">${r.userInput}</td>
            <td style="color:#aaa;">${r.update}</td>
            <td style="color:#aaa;">${r.userUpdate}</td>
            <td style="color:#aaa;">${r.verval}</td>
            <td style="color:#aaa;">${r.verifikator}</td>
            <td style="color:#aaa;">${r.ket}</td>
        </tr>`;
        $tbody.append(tr);
    });
    $('#totalDataCount').text(filtered.length);
}

// Logic Modal Edit, Hapus, Verif (Sama seperti sebelumnya)
window.openModalEdit = function(index) {
    var d = allData[index];
    
    // 1. Isi Field Teks
    $('#editRowIndex').val(d.rowIndex);
    $('#editNamaSD').val(d.namaSD);
    $('#editTahun').val(d.tahun);
    $('#editSem').val(d.sem);
    $('#editKriteria').val(d.kriteria);
    $('#editNomorSK').val(d.noSK);
    $('#editOldDocUrl').val(d.dok); // Simpan URL lama
    $('#editFileUpload').val(''); // Reset input file

    // 2. PERBAIKAN TANGGAL (Agar muncul di input type="date")
    // Input date butuh format: yyyy-mm-dd
    var rawTgl = d.tglSK; 
    var formattedDate = "";
    
    if (rawTgl && rawTgl !== '-') {
        // Coba deteksi format dd/mm/yyyy atau yyyy-mm-dd
        if (rawTgl.includes('/')) {
            // Asumsi: 25/09/2025
            var parts = rawTgl.split(' ')[0].split('/'); // Buang jam jika ada
            if(parts.length === 3) {
                formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`;
            }
        } else if (rawTgl.includes('-')) {
            // Asumsi: 2025-09-25 (sudah benar) atau 25-09-2025
            var parts = rawTgl.split(' ')[0].split('-');
            if(parts[0].length === 4) formattedDate = rawTgl.split(' ')[0]; // yyyy-mm-dd
            else formattedDate = `${parts[2]}-${parts[1]}-${parts[0]}`; // dd-mm-yyyy -> yyyy-mm-dd
        }
    }
    $('#editTanggalSK').val(formattedDate);

    $('#modalEdit').addClass('show');
}

// Helper untuk tombol "Lihat File Saat Ini"
window.previewOldFile = function() {
    var url = $('#editOldDocUrl').val();
    if(url && url !== '#' && url !== '-') {
        window.openDoc(url); // Menggunakan fungsi global yang sudah ada
    } else {
        Swal.fire('Info', 'Tidak ada file sebelumnya.', 'info');
    }
}

// --- SUBMIT EDIT DENGAN FILE UPLOAD ---
function submitEdit(e) {
    e.preventDefault();
    
    var btn = $('#btnSimpanEdit');
    // Simpan teks asli tombol (misal: "Simpan Perubahan")
    // Jika tombol sedang loading, jangan ambil html-nya, tapi hardcode saja biar aman
    var originalText = '<i class="fas fa-save"></i> Simpan Perubahan'; 
    
    var fileInput = document.getElementById('editFileUpload');
    var file = fileInput.files[0];

    // [1] VALIDASI FILE DULUAN (Sebelum tombol dimatikan)
    if (file) {
        // Cek Ukuran (1 MB = 1048576 bytes)
        if (file.size > 1024 * 1024) { 
            showToast('error', 'File Terlalu Besar', 'Maksimal ukuran file adalah 1 MB.'); 
            return; // Stop di sini, tombol masih aktif
        }
        // Cek Tipe
        if (file.type !== 'application/pdf') { 
            showToast('error', 'Format Salah', 'Hanya file PDF yang diperbolehkan.'); 
            return; // Stop di sini
        }
    }

    // [2] BARU UBAH TOMBOL JADI LOADING (Setelah lolos validasi)
    btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Menyimpan...');

    // [3] SIAPKAN DATA
    var formData = {
        rowIndex: $('#editRowIndex').val(),
        nomorSK: $('#editNomorSK').val(),
        tanggalSK: $('#editTanggalSK').val(),
        userUpdate: currentUser,
        fileData: null 
    };

    // Fungsi Pengiriman ke Backend
    var sendToBackend = function() {
        google.script.run
            .withSuccessHandler(res => {
                btn.prop('disabled', false).html(originalText); // Kembalikan tombol
                $('#modalEdit').removeClass('show');
                
                if(res.toString().includes("Error")) {
                    showToast('error', 'Gagal Disimpan', res);
                } else {
                    showToast('success', 'Berhasil', 'Data berhasil diperbarui.');
                    window.initSkDataPage(); 
                }
            })
            .withFailureHandler(err => {
                btn.prop('disabled', false).html(originalText); // Kembalikan tombol jika error server
                showToast('error', 'Error Sistem', err.message);
            })
            .processEditSK(formData);
    };

    // [4] PROSES FILE (Jika ada)
    if (file) {
        var reader = new FileReader();
        
        reader.onload = function(ev) {
            // Konversi ke Base64
            var base64Data = ev.target.result.split(',')[1];
            formData.fileData = {
                mimeType: file.type,
                data: base64Data,
                name: file.name
            };
            sendToBackend(); // Kirim setelah baca file selesai
        };
        
        reader.onerror = function() {
            btn.prop('disabled', false).html(originalText);
            showToast('error', 'Gagal Baca File', 'Terjadi kesalahan saat memproses file.');
        };

        reader.readAsDataURL(file);
    } else {
        sendToBackend(); // Kirim langsung tanpa file
    }
}

window.openModalHapus = function(index) { var d = allData[index]; $('#hapusRowIndex').val(d.rowIndex); $('#hapusKode').val(''); $('#hapusAlasan').val(''); $('#modalHapus').addClass('show'); }

function submitHapus(e) {
    e.preventDefault();
    if($('#hapusKode').val() !== 'HAPUS') {
        showToast('error', 'Kode Salah', 'Kode konfirmasi yang Anda masukkan salah.');
        return;
    }
    
    // Ubah tombol jadi loading
    var btn = $('#modalHapus button[type="submit"]');
    var txt = btn.html();
    btn.prop('disabled',true).text('Menghapus...');

    // ... (Siapkan formData) ...

    google.script.run.withSuccessHandler(res => {
        $('#modalHapus').removeClass('show');
        btn.prop('disabled',false).html(txt);
        
        // TOAST SUCCESS
        showToast('success', 'Data Dihapus', 'Data telah dipindahkan ke Trash.');
        window.initSkDataPage();
    }).processDeleteSK(formData);
}

window.openModalVerif = function(index) { var d = allData[index]; $('#verifRowIndex').val(d.rowIndex); $('#verifNamaSD').val(d.namaSD); $('#verifNomorSK').val(d.noSK); $('#verifKriteria').val(d.kriteria); $('#verifStatus').val(d.status==='OK'?'OK':(d.status==='Ditolak'?'Ditolak':'Diproses')); $('#verifKeterangan').val(d.ket||''); var id = (d.dok||'').match(/[-\w]{25,}/); if(id) $('#verifPreviewFrame').attr('src', "https://drive.google.com/file/d/" + id[0] + "/preview"); else $('#verifPreviewFrame').attr('src', ""); $('#modalVerif').addClass('show'); }
function submitVerif(e) { e.preventDefault(); Swal.fire({title:'Menyimpan...', didOpen:()=>Swal.showLoading()}); google.script.run.withSuccessHandler(res => { $('#modalVerif').removeClass('show'); Swal.fire('Tersimpan', res, 'success'); window.initSkDataPage(); }).processVerifySK({ rowIndex: $('#verifRowIndex').val(), statusVerif: $('#verifStatus').val(), keterangan: $('#verifKeterangan').val(), verifikator: currentUser }); }

$('#searchInput, #filterTahun, #filterSemester, #filterStatus').on('input change', function() { applyFilter(true); });
window.openDoc = function(url) { var id = url.match(/[-\w]{25,}/); if(id) window.open(url, '_blank'); }

window.initSkDataPage();
</script>